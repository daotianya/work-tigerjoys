
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1,user-scalable=no" />
<title>崇祯王朝第一部:02 - 蓝蜜蜂</title>
<link rel="stylesheet" href="http://bluebee.b0.upaiyun.com/app/community/community.css" />
<style type="text/css">
.tl p{width:auto;}
.part .talk{background:#fff;padding-bottom:50px;}
.part .talk h2{font-weight: normal;padding: 5px 10px;color: #666;font-size: 12px;}
.part .talk .talk_list{padding:0;overflow-x: hidden;overflow-y: visible;height: 300px;}
.part .talk .talk_list li{min-height:20px;line-height:20px;border-bottom:1px solid #d9d9de;padding:4px 10px;word-wrap:break-word;word-break:break-all;}
.part .talk .talk_list li.male span{color:#3D40E1;}
.part .talk .talk_list li.female span{color:#E5258B}
.part .talk .talk_list span{color:#155143}
</style>
</head>
<body>
<div class="head">
	<a href="javascript:window.target.clickOnTarget('goback','','');" class="back"></a>
	蜂蜜柚子茶
</div>
<div class="tl bm">	 
	<div class="bott">
	   <h4>本期内容：崇祯王朝第一部:02</h4>	   
	</div>
	<div id="player" style="overflow:hidden;">
		<img src="http://pbluebee.didiman.com/upload/tmp/duanzi_03.jpg" />
		<span class="but" style="display:none;background-image:url('http://bluebee.b0.upaiyun.com/app/community/stop.png')"></span>
		<div class="ctrl" style="display:none;">
			<div class="left"><span class="time" id="stime">00:00</span></div>
			<div class="dragbar">
				<span class="bar" id="bar_1"></span>	
				<span class="drag" id="drag"></span>	
			</div>
			<div class="right"><span class="time" id="ctime">22:45</span></div>
		</div>
		<div class="progressbar" data-perc="0" style="display:block;">
			<div class="bar" id="bar_2"></div>
			<div class="label"><span></span></div>
		</div>
		<div class="load" id="loading" style="display:none;">
			<div class="animate"></div>
		</div>
	</div>
		<p class="space">简介：你好啊，我就是崇祯皇帝。</p>
	</div>
<div class="part">
	<div class="commend">
		<h2 class="bm">最新评论</h2>
		<div id="wrapper" style="overflow-y: auto;height: 300px;padding-bottom: 50px;">
			<div style="overflow:hidden;">
				<div class="list" id="comment_list" style="padding-bottom:0;">
					<dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://bluebee.b0.upaiyun.com/img/default_user.png" /></p></div></dt>
						<dd>
							<h3>游客</h3>
							<span class="time">01-22 15:57</span>
							<p>么么</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://bluebee.b0.upaiyun.com/img/default_user.png" /></p></div></dt>
						<dd>
							<h3>游客</h3>
							<span class="time">01-22 15:53</span>
							<p>我加了你来了</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://bluebee.b0.upaiyun.com/img/default_user.png" /></p></div></dt>
						<dd>
							<h3>游客</h3>
							<span class="time">01-22 15:52</span>
							<p>竭尽全力，</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://bluebee.b0.upaiyun.com/img/default_user.png" /></p></div></dt>
						<dd>
							<h3>游客</h3>
							<span class="time">01-22 15:51</span>
							<p>你微博是多少？</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://bluebee.b0.upaiyun.com/img/default_user.png" /></p></div></dt>
						<dd>
							<h3>游客</h3>
							<span class="time">01-22 15:51</span>
							<p>帐篷</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://bluebee.b0.upaiyun.com/img/default_user.png" /></p></div></dt>
						<dd>
							<h3>游客</h3>
							<span class="time">01-22 15:51</span>
							<p>nishisgua</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://bluebee.b0.upaiyun.com/img/default_user.png" /></p></div></dt>
						<dd>
							<h3>游客</h3>
							<span class="time">01-22 15:48</span>
							<p>你晒</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://pbluebee.didiman.com/upload/user/2016/01/20/1453262062907_3516.jpg" /></p></div></dt>
						<dd>
							<h3>LMF3570951332</h3>
							<span class="time">01-22 14:52</span>
							<p>一进行</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://pbluebee.didiman.com/upload/user/2016/01/20/1453262062907_3516.jpg" /></p></div></dt>
						<dd>
							<h3>LMF3570951332</h3>
							<span class="time">01-22 10:51</span>
							<p>嘻嘻嘻i想</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://pbluebee.didiman.com/upload/user/2016/01/20/1453262062907_3516.jpg" /></p></div></dt>
						<dd>
							<h3>LMF3570951332</h3>
							<span class="time">01-22 10:51</span>
							<p>呵呵呵</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://pbluebee.didiman.com/upload/user/2016/01/20/1453262062907_3516.jpg" /></p></div></dt>
						<dd>
							<h3>LMF3570951332</h3>
							<span class="time">01-22 10:51</span>
							<p>你好啊。。</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://pbluebee.didiman.com/upload/user/2016/01/20/1453262062907_3516.jpg" /></p></div></dt>
						<dd>
							<h3>LMF3570951332</h3>
							<span class="time">01-22 10:26</span>
							<p>对了。你们别忘记点赞啊。</p>
						</dd>
					</dl>
								    <dl>
						<dt class="c_face"><div class="c_div"><p class="c_p"><img src="http://pbluebee.didiman.com/upload/user/2016/01/20/1453262062907_3516.jpg" /></p></div></dt>
						<dd>
							<h3>LMF3570951332</h3>
							<span class="time">01-22 10:26</span>
							<p>马上要开始了。大家赶紧打开音响。。故事会来咯。</p>
						</dd>
					</dl>
				</div>
			</div>
		</div>	
	</div>
</div>
<div class="part" >
	<div class="box" >
		<input type="button" value="提交" id="comment_btn" class="btn"/>
		<input type="text" value="" maxlength="300" placeholder="说点什么吧！" id="comment_txt" class="txt" />
	</div>
</div>
<script src="http://bluebee.b0.upaiyun.com/static/js/jquery-1.10.2.min.js"></script>
<script src="http://bluebee.b0.upaiyun.com/static/js/zoom.js"></script>
<script type="text/javascript">
var alineId = 42;
var generatedCount = 0;
function pullUpAction () {
	 if(true) return;	if(generatedCount == 1) return;
	generatedCount = 1;
	
	getData(2);
}

function getData(t){
	var type = t;
	$.ajax({
		url : '/web/community/video/comment/6',
		data : {'alineId':alineId},
		type : 'post',
		dataType : 'json',
		beforeSend: function(xhr){xhr.setRequestHeader('header-encrypt-code', '');},
		success : function(result){
			if(type == 1) {
				$('#comment_list').empty();
				pullDownEl.className = '';
				myScroll.refresh();
			}
			
			if(result.commentList.length == 0) {
				if(type == 2) {
					pullUpEl.className = '';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '暂无数据...';
				}
			} else {
				var s = '';
				for(i in result.commentList) {
					var item = result.commentList[i];
					s += '<dl>';
					s += '<dt class="c_face"><div class="c_div"><p class="c_p"><img src="'+item.user_face+'" /></p></div></dt>';
					s += '<dd>';
					s += '<h3>'+item.user_name+'</h3>';
					s += '<span class="time">'+item.create_date+'</span>';
					s += '<p>'+item.content+'</p>';
					s += '</dd>';
					s += '</dl>';
				}
				var t = $(s);
				$('#comment_list').append(t);
				
				var list = t.find('img');
				var i = list.length;
				var c = 0;
				list.each(function(){
					var Img = new Image();
					Img.onload = function (){
						c++;
						if(c >= i) {
							myScroll.refresh();
						}
					} 
					Img.src = $(this).attr('src');
				});
				myScroll.refresh();
				alineId = result.newAlineId;
			}
		},
		complete : function(){
			generatedCount = 0;
		}
	});
}

var totalTime = 1365;
var videoPlayer;
var isTouchDrag = false;
var startTime = 1453452772;
var serverTime = 1453526026;
var beginTimer = null , hideControlTimer = null;
var pageZoom = 1;
var dragLeft = 52 , twidth = 210;
var playerFinish = false;
var url = 'http://pbluebee.didiman.com/upload/tmp/02.mp3';
function initPlayer(type){
	$('#player').append('<audio id="videoPlayer" src="'+url+'" autoplay="autoplay"></audio>');
	
	videoPlayer = $('#videoPlayer').get(0);
	videoPlayer.addEventListener("timeupdate", progressBar, true);
	videoPlayer.addEventListener("play", function(){
		if(type==0) $('#bofangTxt').html('正在直播');
    	//计算当前播放到什么时候了。
        if(startTime + totalTime > serverTime) {
        	//alert(videoPlayer.currentTime+'=='+serverTime+'=='+startTime);
            videoPlayer.currentTime = serverTime - startTime;
        }
    	$('#loading').hide();
        
    	$('#player').bind("click",function(){
    		//console.log((startTime+totalTime)+'-'+serverTime);
    		if(playerFinish || startTime+totalTime>serverTime) return;
    		if($(".progressbar").is(":hidden")){
    			$(".ctrl,.but").hide(400,function(){
    				$(".progressbar").show();
    			});
    		} else {
    			$(".progressbar").hide();
    			$(".ctrl,.but").show(400);
    			
    			startShowController();
    		}
    	});
	}, true);
	
	$('#loading').show();
	
	//计算当前播放到什么时候了。
	/*if(startTime + totalTime > serverTime) {
		videoPlayer.currentTime = serverTime - startTime;
	}
	
	videoPlayer.play();*/
	//if(type!=2) $('#bofangTxt').html('正在加载中...');
}

function progressBar(){
	var elapsedTime = videoPlayer.currentTime;
	//console.log(elapsedTime);
	setPrce(Math.round(videoPlayer.currentTime));
}

function formatTime(t){
	var min = ~~(t/60);
	var sec = t%60;
	//console.log(min+'--'+sec);
	
	return (min<10?'0'+min:min)+':'+(sec<10?'0'+sec:sec);
}

function setPrce(currTime){
	var c = currTime/totalTime*100;
	$('#bar_2').css({'width':c+'%'});
	
	if(!isTouchDrag) {
		var l = twidth*c/100+dragLeft;
		$('#drag').css("left",l+"px");
		$('#bar_1').css({'width':c+'%'});
	}
	
	$('#stime').text(formatTime(currTime));
	
	if(currTime >= totalTime) {
		stop();
		if(hideControlTimer != null) {
			clearInterval(hideControlTimer);
			hideControlTimer = null;
		}
		playerFinish = true;
	}
}

function play(){
	videoPlayer.play();
	playerFinish = false;
	startShowController();
	$(".but").css("background-image","url('http://bluebee.b0.upaiyun.com/app/community/stop.png')");
}

function stop(){
	videoPlayer.pause();
	$(".but").css("background-image","url('http://bluebee.b0.upaiyun.com/app/community/start.png')");
	if($(".progressbar").is(":visible")) {
		$(".progressbar").hide();
		$(".ctrl,.but").show();
	}
	
	if(hideControlTimer != null) {
		clearInterval(hideControlTimer);
		hideControlTimer = null;
	}
}
function replay(){
	videoPlayer.currentTime = 0;
	play();
}

function startShowController(){
	//此处开启定时器
	if(hideControlTimer != null) return;
	var countDown = 0;
	hideControlTimer = setInterval(function(){
		countDown++;
		if(countDown > 3) {
			$(".ctrl,.but").hide(400,function(){
				$(".progressbar").show();
				once = 1;
			});
			
			clearInterval(hideControlTimer);
			hideControlTimer = null;
		}
	},1000);
}

$(document).ready(function(){
	pageZoom = $("html").css("zoom");
    $(":text").focus(function(){
		$(".box").css('padding-bottom',$(window).height()/pageZoom/2);
	});
	$(":text").blur(function(){
		setTimeout("$('.box').css('padding-bottom',10)",10);
	});

	var wrapper = $('#wrapper') , comment_list = $('#comment_list') , wrapperMaxTop = wrapper.height();
	wrapper.scroll(function(){
		var top = wrapper.scrollTop();

		//此处需要加载历史
		if(comment_list.height() - wrapperMaxTop - top < 100) {
			console.log('加载中....');
			pullUpAction();
		}
	});
	
	//回放音频按钮
	var h = $(".head").height()+$(".tl .bott").height()+($(".tl img").height()-$(".but").height())/2;
	var w = ($(".tl img").width()-$(".but").width())/2;
	$(".but").css({"top":h+"px","left":w+"px"});	
	$(".but").bind("click",function(e){
		var but = $(this);
		e.stopPropagation();
		if(videoPlayer.paused){
			if(playerFinish) {
				replay();
			} else {
				play();
			}
		} else {
			stop();
		}	
	});
	$(".ctrl").bind("click",function(e){e.stopPropagation();});
	//回放音频进度条
	var top = $(".head").height()+$(".tl .bott").height()+$(".tl img").height()-$(".ctrl").height()+3;
	$(".ctrl").css({"top":top+"px","left":0+"px"});
	
	$('#player').get(0).addEventListener('touchstart' , function(){
		//console.log(2);
		if(playerFinish || startTime+totalTime>serverTime) return;
		if(hideControlTimer != null) {
			clearInterval(hideControlTimer);
			hideControlTimer = null;
		}
	});
	$('#player').get(0).addEventListener('touchend', function(event) {
		//console.log(3);
		if(playerFinish || startTime+totalTime>serverTime) return;
		//此处开启定时器
		startShowController();
	});
	
	//拖拽bar
	var origin = $(".dragbar").position().left;
	var drag = document.getElementById('drag');
    drag.addEventListener('touchmove', function(event) {
		var drag = $(this);
		event.preventDefault();//阻止其他事件
		// 如果这个元素的位置内只有一个手指的话
		if (event.targetTouches.length == 1 && startTime+totalTime<serverTime) {
			var touch = event.targetTouches[0];  // 把元素放在手指所在的位置
			var posX = touch.pageX/pageZoom;
			//console.log(posX);
			if(posX>=dragLeft && posX<=(twidth+dragLeft)){
				drag.css("left",posX+"px");
				
				var c = (posX-dragLeft)/twidth*100;
				$("#bar_1").css("width",c+"%");
			}else{
				if(posX<dragLeft){
					drag.css("left",dragLeft+"px");
					$("#bar_1").css("width","0px");
				}
				if(posX>(twidth+dragLeft)){
					drag.css("left",(twidth+dragLeft)+"px");
					$("#bar_1").css("width","100%");
				}
			} 
		}
   }, false);
    
    
	drag.addEventListener('touchstart' , function(){
		//console.log('xx');
		isTouchDrag = true;
	});
    drag.addEventListener('touchend' , function(){
    	//console.log('yy');
    	isTouchDrag = false;
    	
    	if(startTime+totalTime<serverTime) {
    		var c = parseInt($('#bar_1').css('width'))/212;
        	//console.log(c);
        	var currTime = ~~(totalTime*c);
        	//console.log(currTime);
        	
        	videoPlayer.currentTime = currTime;
    	}
    });
   
    //直播还未开始，则默认启动一个线程
   if(startTime > serverTime) {
	   beginTimer = setInterval(function(){
		   serverTime+=1;
		   if(startTime <= serverTime) {
			   clearInterval(beginTimer);
			   initPlayer(0);
		   }
	   },1000);
   } else if(startTime+totalTime>serverTime){
	   beginTimer = setInterval(function(){
		   serverTime += 1;
	   },1000);
	   initPlayer(1);
   } else {
	   initPlayer(2);
   }
    
   $('#comment_btn').bind('click',function(){
	   var content = $.trim($('#comment_txt').val());
	   $('#comment_txt').val(content);
	   if(content == '') {
		   alert('请输入你想评论的内容');
		   return;
	   }
	   if(content.length > 300) {
		   alert('评论内容不能超过300个字');
		   return;
	   }
	   $('#comment_txt').val('');
	   $.ajax({
			url : '/web/community/video/6/comment',
			data : {'content':content , 'videoId' : 6},
			type : 'post',
			dataType : 'json',
			beforeSend: function(xhr){xhr.setRequestHeader('header-encrypt-code', '');},
			success : function(result){
				if(result.code==0) {
					console.log('comment success');
										getData(2);
									} else {
					alert(result.codemsg);
				}
			}
	   });
   });
   $('#comment_txt').keyup(function(event){
	   if(event.keyCode==13) {
		   $('#comment_btn').click();
		   $('#comment_txt').blur();
	   }
   });
   });
</script>

</body>
</html>
